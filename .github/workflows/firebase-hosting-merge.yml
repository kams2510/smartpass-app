# This file has been customized for a multi-app monorepo structure.

name: Deploy all apps to Firebase Hosting on merge

on:
  push:
    branches:
      - main 

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # Install Node.js environment
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Install all project dependencies once in the root folder (if any root dependencies exist)
      - name: Install Root Dependencies
        run: npm ci

      # --- 1. BUILD & DEPLOY ADMIN DASHBOARD ---
      - name: Build Admin Dashboard
        run: npm ci --prefix admin-dashboard && npm run build --prefix admin-dashboard 
      - name: Deploy Admin Dashboard
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_SMARTPASS_APP_48365 }}
          projectId: smartpass-app-48365
          target: admin-dashboard # TARGETED DEPLOYMENT
          channelId: live

      # --- 2. BUILD & DEPLOY CONDUCTOR APP ---
      - name: Build Conductor App
        run: npm ci --prefix conductor-app && npm run build --prefix conductor-app
      - name: Deploy Conductor App
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_SMARTPASS_APP_48365 }}
          projectId: smartpass-app-48365
          target: conductor-app # TARGETED DEPLOYMENT
          channelId: live

      # --- 3. BUILD & DEPLOY STUDENT PORTAL ---
      - name: Build Student Portal
        run: npm ci --prefix student-portal && npm run build --prefix student-portal
      - name: Deploy Student Portal
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_SMARTPASS_APP_48365 }}
          projectId: smartpass-app-48365
          target: student-portal # TARGETED DEPLOYMENT
          channelId: live